# 第六次打卡学习任务

**学习范围：** P175-P240

## Servlet是什么

是Java Web的三大组件之一，属于动态资源。作用是处理请求，服务器会把接收到的请求交给Servlet处理，在Servelt中通常需要

- 接收请求数据
- 处理请求
- 完成请求

实现Servlet有三种方式

- 实现javax.servlet.Servlet接口
- 继承javax.servlet.GenericServlet类
- 继承javax.servlet.http.HttpServlet类

## javax.servlet.Servlet接口探究

- destroy() 生命周期方法，servlet实例被销毁前调用，且只会被调用一次
- getServletConfig() 获取servlet设置
- getServletInfo() 获取servlet信息
- init() 初始化
- service() 生命周期方法，会被调用多次，每次请求都会被调用

## Servlet路由

如下是IDE自动构建的web.xml文件，位于WEB-INF目录中

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
         version="4.0">
</web-app>
```

如果需要将一个url路由到某个继承了Servlet的类的话，可以在这个xml文件中的**web-app**tag中加入**servlet**和**servlet-mapping**tag，IDE貌似也有相关的向导可以自动添加tag

示范如下

```xml
<servlet>
    <servlet-name>UserPage</servlet-name>
    <servlet-class>club.piclight.JavaWeb.UserPage</servlet-class>
</servlet>
<servlet-mapping>
    <servlet-name>UserPage</servlet-name>
    <url-pattern>/user</url-pattern>
</servlet-mapping>
```

从Java EE5开始，还可以为一个servlet-name设置多个url了

当访问`http://host.com/user`这样的url时，就会路由到club.piclight.JavaWeb.UserPage这个已经继承了Servlet的类。背后是从配置文件读取到类名，接着通过反射，访问该类，已经相应的处理方法，比如说`doGet()`或`doPost()`方法


还有一个不需要修改web.xml配置文件以达到mapping的方法————在继承了Servlet的类中class声明前加入**WebServlet注解**，例如`@WebServlet(name = "UserPage", urlPatterns = "/user")`这样。当然还有很多选项，IDE会很方便的给出提示。

### 默认匹配

当未匹配到任何路径时，将按照配置文件匹配到默认的servlet，下面展示默认的servlet配置`web.xml`

默认servlet配置，比如说404页面的配置

```xml
<servlet>
    <servlet-name>default</servlet-name>
    <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
    <init-param>
        <param-name>debug</param-name>
        <param-value>0</param-value>
    </init-param>
    <init-param>
        <param-name>listings</param-name>
        <param-value>false</param-value>
    </init-param>
    <load-on-startup>1</load-on-startup>
</servlet>
```

默认jsp处理

```xml
<servlet>
    <servlet-name>jsp</servlet-name>
    <servlet-class>org.apache.jasper.servlet.JspServlet</servlet-class>
    <init-param>
        <param-name>fork</param-name>
        <param-value>false</param-value>
    </init-param>
    <init-param>
        <param-name>xpoweredBy</param-name>
        <param-value>false</param-value>
    </init-param>
    <load-on-startup>3</load-on-startup>
</servlet>
```

默认路由配置

```xml
<!-- The mapping for the default servlet -->
<servlet-mapping>
    <servlet-name>default</servlet-name>
    <url-pattern>/</url-pattern>
</servlet-mapping>

<!-- The mappings for the JSP servlet -->
<servlet-mapping>
    <servlet-name>jsp</servlet-name>
    <url-pattern>*.jsp</url-pattern>
    <url-pattern>*.jspx</url-pattern>
</servlet-mapping>
```

## 配置web.xml中init-param的以配置参数

在文件web.xml -> web.app(tag) -> servlet(tag)中添加init-param(tag)

示范

```xml
<init-param>
    <param-name>adminName</param-name>
    <param-value>Linus</param-value>
</init-param>
```

接着在Servlet类中使用`getInitParameter("adminName")`即可得到Linus(value)。**注意，这个是配置文件的参数，与HTTP网络请求的参数没有关系** ~~被书误导了~~

### 配置web.xml中context-param以达到全局效果

由于init-param tag内嵌于servlet tag,所以仅能被当前servlet访问，如果想做到全局访问，可以使用web.app(tag) -> context-param(tag)

示范

```xml
<context-param>
    <param-name>adminName</param-name>
    <param-value>Linux</param-value>
</context-param>
```


这时候想要访问该参数需要在`getInitParameter("adminName")`修改为`getServletContext().getInitParameter("adminName")`

**在`{CATALINA_HOME}/conf/web.xml`中写入的`web.xml`相当于写到了每一个web.xml文件中，他将作用于所有webapp**

//## javax.servlet.GenericServlet

## 域对象

ServletContext是JavaWeb四大对象之一

四大对象：

- PageContext
- ServletRequest
- HttpServlet
- ServletContext

所有域都有存储数据的功能，因为域对象内部有一个Map，用于存储数据

- setAttribute(String name, Object object) 设置域对象
- getAttribute(String name) 获取域对象
- removeAttribute(String name) 删除键值

## HTTP请求

### GET Method

以下是一个简单的表单请求的html示范

```html
<form action="/url" method="get">
    <input type="text" name="info">
    <input type="submit">
</form>
```

在servlet类中调用HttpServletResponse对象的getParameter("key")方法会返回GET请求中key所对应的value
以下为servlet类中调用GET请求的参数示范

```Java
protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        req.setCharacterEncoding("UTF-8");
        resp.setCharacterEncoding("UTF-8");
        resp.setContentType("text/html");

        PrintWriter out = resp.getWriter();
        out.println("Info=" + req.getParameter("info"));
    }
```

action为请求URL参数，实际请求时会请求至`主域 + /url`这样子，method为请求方式，name中的info作为post请求的键值名(key)，与input text框中的数据作为数据(value)一起传送。以GET方法提交数据时，浏览器会把表单内容组织成一个查询字符串并加载URL+?后面。各个变量之间以&分隔，GET请求适用于查询。

### POST Method

与GET Method十分相似

以下是一个简单的表单请求的html示范

```html
<form action="/url" method="post">
    <input type="text" name="infoA">
    <input type="text" name="infoB">
    <input type="submit">
</form>
```

在servlet类中调用HttpServletResponse对象的getParameter("key")方法会返回GET请求中key所对应的value
以下为servlet类中调用POST请求的参数示范

```Java
protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
        req.setCharacterEncoding("UTF-8");
        resp.setCharacterEncoding("UTF-8");
        resp.setContentType("text/html");

        PrintWriter out = resp.getWriter();
        out.println("Info=" + req.getParameter("infoA"));
        out.println("Info=" + req.getParameter("infoB"));
    }
```

### 请求码返回

设置HTTP响应头的状态码，状态码规范参见RFC文档

```java
resp.setStatus(int sc); //响应码设定
resp.sendError(int sc, String msg) //发送响应码，并且清空buffer
```

### Encoding编码问题

如果查询内容中有中文字符，务必注意Tomcat上Encoding的设置。如果出现意外，最好在server.xml将Encoding设置为UTF-8

```xml
<Connector port="8080" protocol="HTTP/1.1" connectionTimeout="20000" redirectProt="8443" URIEncoding="UTF-8"/>
```






===================================================
## 参考资料
[Java EE 7 Docs](https://docs.oracle.com/javaee/7/api/toc.htm)
